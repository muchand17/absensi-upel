<!DOCTYPE html>
<html lang="id">
<head>
    <base target="_top">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi Mixue</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- CSS UTAMA (Punya lu tetep gua pake) --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .app-container {
            width: 100%;
            max-width: 400px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        h2 { text-align: center; color: #bb86fc; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; }
        input, select {
            width: 100%; padding: 12px; background: #2c2c2c;
            border: 1px solid #333; border-radius: 8px; color: white;
            font-size: 16px; box-sizing: border-box;
        }
        
        .btn-scan {
            width: 100%; padding: 15px;
            background: linear-gradient(45deg, #bb86fc, #3700b3);
            border: none; border-radius: 8px; color: white;
            font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }
        .btn-scan:disabled {
            background: #555; cursor: not-allowed;
        }

        /* --- CSS POP-UP KAMERA (MODAL) --- */
        #camera-modal {
            display: none; 
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95);
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #reader {
            width: 100%;
            max-width: 400px;
            border: 2px solid #bb86fc;
            border-radius: 10px;
        }

        .btn-close {
            margin-top: 20px;
            padding: 10px 30px;
            background: #cf6679;
            color: white; border: none; border-radius: 50px;
            font-size: 16px; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="app-container">
    <h2>Absensi Lab Mixue</h2>

    <form id="formAbsen" onsubmit="event.preventDefault();">
        <div class="form-group">
            <label>Nama Lengkap</label>
            <input type="text" id="nama" name="nama" placeholder="Contoh : Gibran cahaya Asia">
        </div>

        <div class="form-group">
            <label>Status</label>
            <select id="status" name="status">
                <option value="Masuk">üü¢ Masuk Shift</option>
                <option value="Pulang">üî¥ Pulang Shift</option>
            </select>
        </div>

        <div class="form-group">
            <label>Shift Ke-</label>
            <select id="shift" name="shift">
                <option value="1">Shift 1 (Pagi)</option>
                <option value="2">Shift 2 (Siang)</option>
                <option value="3">Lembur / Ganti</option>
            </select>
        </div>

        <div class="form-group">
            <label>Jam</label>
            <input type="text" id="waktu" name="waktu" readonly style="background: #333; color: #888;">
        </div>
        
        <input type="hidden" id="qrData" name="qrData">

        <button class="btn-scan" onclick="bukaKamera()">üì∑ Scan QR & Absen</button>
    </form>
</div>

<div id="camera-modal">
    <div style="color: white; margin-bottom: 10px;">Arahkan ke QR Code Tembok</div>
    <div id="reader"></div>
    <button class="btn-close" onclick="tutupKamera()">Batal</button>
</div>

<script>
    // --- LOGIC JAM OTOMATIS ---
    function updateJam() {
        const now = new Date();
        document.getElementById('waktu').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    }
    setInterval(updateJam, 1000);
    updateJam();

    // --- VARIABLE GLOBAL ---
    let html5QrCode;
    let isProcessing = false;

    // --- FUNGSI BUKA KAMERA ---
    function bukaKamera() {
        const nama = document.getElementById('nama').value;
        if (!nama) { alert("Isi nama dulu bre!"); return; }

        document.getElementById('camera-modal').style.display = 'flex';
        isProcessing = false;

        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess
        ).catch(err => {
            alert("Kamera error: " + err);
            tutupKamera();
        });
    }

    // --- FUNGSI TUTUP KAMERA ---
    function tutupKamera() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                document.getElementById('camera-modal').style.display = 'none';
            }).catch(err => {
                console.log("Stop failed", err);
                document.getElementById('camera-modal').style.display = 'none';
            });
        } else {
            document.getElementById('camera-modal').style.display = 'none';
        }
    }

    // --- FUNGSI SAAT QR KEBACA ---
    function onScanSuccess(decodedText, decodedResult) {
        if (isProcessing) return;
        isProcessing = true; 
        
        // Simpan hasil scan ke hidden input
        document.getElementById('qrData').value = decodedText;

        tutupKamera();
        kirimDataGoogleScript(); // Panggil fungsi kirim yang baru
    }

    // --- FUNGSI KIRIM DATA (PAKE APPS SCRIPT NATIVE) ---
    // Ini pengganti Fetch yang lu maki-maki tadi
    function kirimDataGoogleScript() {
        const btn = document.querySelector('.btn-scan');
        const formObject = document.getElementById('formAbsen'); // Ambil semua data di form

        btn.innerHTML = "‚è≥ Mengirim ke Server...";
        btn.disabled = true;

        // PANGGIL BACKEND (Code.gs)
        google.script.run
            .withSuccessHandler(function(response) {
                // Kalo SUKSES
                alert("‚úÖ MANTAP! " + response);
                btn.innerHTML = "üì∑ Scan QR & Absen";
                btn.disabled = false;
                document.getElementById('formAbsen').reset(); // Reset form
                updateJam(); // Balikin jam
            })
            .withFailureHandler(function(error) {
                // Kalo ERROR
                alert("‚ùå GOBLOK ERROR: " + error.message);
                btn.innerHTML = "üì∑ Scan QR & Absen";
                btn.disabled = false;
                isProcessing = false; // Reset kunci biar bisa scan lagi
            })
            .prosesAbsensi(formObject); // Nama fungsi di Code.gs harus 'prosesAbsensi'
    }
</script>

</body>
</html>
