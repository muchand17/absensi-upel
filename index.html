<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Absensi Mixue</title>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <style>
        /* --- CSS UTAMA --- */
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #121212;
            color: #e0e0e0;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .app-container {
            width: 100%;
            max-width: 400px;
            background-color: #1e1e1e;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }
        h2 { text-align: center; color: #bb86fc; margin-bottom: 20px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; color: #aaa; }
        input, select {
            width: 100%; padding: 12px; background: #2c2c2c;
            border: 1px solid #333; border-radius: 8px; color: white;
            font-size: 16px; box-sizing: border-box;
        }
        
        .btn-scan {
            width: 100%; padding: 15px;
            background: linear-gradient(45deg, #bb86fc, #3700b3);
            border: none; border-radius: 8px; color: white;
            font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px;
        }

        /* --- CSS POP-UP KAMERA (MODAL) --- */
        #camera-modal {
            display: none; /* Sembunyi dulu */
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.95); /* Gelap total belakangnya */
            z-index: 9999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        #reader {
            width: 100%;
            max-width: 400px;
            border: 2px solid #bb86fc;
            border-radius: 10px;
        }

        .btn-close {
            margin-top: 20px;
            padding: 10px 30px;
            background: #cf6679;
            color: white; border: none; border-radius: 50px;
            font-size: 16px; cursor: pointer;
        }
    </style>
</head>
<body>

<div class="app-container">
    <h2>Absensi Lab</h2>

    <div class="form-group">
        <label>Nama Lengkap</label>
        <input type="text" id="nama" placeholder="Contoh : Gibran cahaya Asia">
    </div>

    <div class="form-group">
        <label>Status</label>
        <select id="status">
            <option value="Masuk">üü¢ Masuk Shift</option>
            <option value="Pulang">üî¥ Pulang Shift</option>
        </select>
    </div>

    <div class="form-group">
        <label>Shift Ke-</label>
        <select id="shift">
            <option value="1">Shift 1 (Pagi)</option>
            <option value="2">Shift 2 (Siang)</option>
            <option value="3">Lembur / Ganti</option>
        </select>
    </div>

    <div class="form-group">
        <label>Jam</label>
        <input type="text" id="waktu" readonly style="background: #333; color: #888;">
    </div>

    <button class="btn-scan" onclick="bukaKamera()">üì∑ Scan QR</button>
</div>

<div id="camera-modal">
    <div style="color: white; margin-bottom: 10px;">Arahkan ke QR Code Tembok</div>
    <div id="reader"></div>
    <button class="btn-close" onclick="tutupKamera()">Batal</button>
</div>

<script>
    // --- LOGIC JAM OTOMATIS ---
    function updateJam() {
        const now = new Date();
        document.getElementById('waktu').value = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
    }
    setInterval(updateJam, 1000);
    updateJam();

    // --- VARIABLE GLOBAL (State Management) ---
    let html5QrCode;
    let isProcessing = false; // KUNCI UTAMA BIAR GAK SPAM

    // --- FUNGSI BUKA KAMERA (MODAL) ---
    function bukaKamera() {
        const nama = document.getElementById('nama').value;
        if (!nama) { alert("Isi nama dulu bre!"); return; }

        // Munculin Modal
        document.getElementById('camera-modal').style.display = 'flex';
        
        // Reset kunci
        isProcessing = false;

        // Start Library Kamera
        html5QrCode = new Html5Qrcode("reader");
        html5QrCode.start(
            { facingMode: "environment" }, 
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess // Kalau berhasil, panggil fungsi ini
        ).catch(err => {
            alert("Kamera error: " + err);
            tutupKamera();
        });
    }

    // --- FUNGSI TUTUP KAMERA ---
    function tutupKamera() {
        if (html5QrCode) {
            html5QrCode.stop().then(() => {
                html5QrCode.clear();
                document.getElementById('camera-modal').style.display = 'none';
            }).catch(err => {
                console.log("Stop failed", err);
                document.getElementById('camera-modal').style.display = 'none';
            });
        } else {
            document.getElementById('camera-modal').style.display = 'none';
        }
    }

    // --- FUNGSI SAAT QR KEBACA (LOGIC INTI) ---
    function onScanSuccess(decodedText, decodedResult) {
        // CEK KUNCI: Kalau lagi proses, jangan ngapa-ngapain (Anti Spam)
        if (isProcessing) return;
        
        // KUNCI LANGSUNG DIPASANG
        isProcessing = true; 
        
        // Stop Kamera dulu biar user tau udah sukses scan
        tutupKamera();
        
        // Proses Kirim Data
        kirimData(decodedText);
    }

    // --- FUNGSI KIRIM DATA (FETCH) ---
    function kirimData(urlScript) {
        // Feedback Visual (Loading)
        const btn = document.querySelector('.btn-scan');
        btn.innerHTML = "‚è≥ Sedang Mengirim...";
        btn.disabled = true;

        const dataAbsen = {
            nama: document.getElementById('nama').value,
            status: document.getElementById('status').value,
            shift: document.getElementById('shift').value,
            waktu: document.getElementById('waktu').value
        };

        // TEKNIK KIRIM DATA TEXT/PLAIN (Biar ga diblokir Google Script)
        fetch(urlScript, {
            method: "POST",
            mode: "no-cors", // Wajib buat Google Script
            headers: {
                "Content-Type": "text/plain" // Tips: Pake text/plain lebih aman daripada application/json
            },
            body: JSON.stringify(dataAbsen)
        })
        .then(() => {
            // Karena no-cors, kita ASUMSIKAN sukses kalau fetch selesai tanpa error network
            alert("‚úÖ Data " + dataAbsen.nama + " Berhasil Masuk!");
            window.location.reload(); // Refresh halaman
        })
        .catch(error => {
            alert("‚ùå Error: " + error);
            btn.innerHTML = "üì∑ Scan QR";
            btn.disabled = false;
            isProcessing = false; // Buka kunci kalau error biar bisa coba lagi
        });
    }

// --- FUNGSI KIRIM DATA (FINAL VERSION) ---
    function kirimData(urlScript) {
        const btn = document.querySelector('.btn-scan');
        btn.innerHTML = "‚è≥ Mengirim...";
        btn.disabled = true;

        const dataAbsen = {
            nama: document.getElementById('nama').value,
            status: document.getElementById('status').value,
            shift: document.getElementById('shift').value,
            waktu: document.getElementById('waktu').value
        };

        // PENTING: Gunakan text/plain biar lolos sensor Google
        fetch(urlScript, {
            method: "POST",
            mode: "no-cors", 
            headers: {
                "Content-Type": "text/plain" 
            },
            body: JSON.stringify(dataAbsen)
        })
        .then(() => {
            // Karena no-cors, kita anggap sukses kalau request terkirim
            alert("‚úÖ ABSEN MASUK!\nNama: " + dataAbsen.nama + "\nStatus: " + dataAbsen.status);
            window.location.reload(); 
        })
        .catch(error => {
            alert("‚ùå Gagal: " + error);
            btn.innerHTML = "üì∑ Scan QR";
            btn.disabled = false;
            isProcessing = false;
        });
    }
</script>

</body>
</html>

